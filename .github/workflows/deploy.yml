name: Build and Push Deploy Branch

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Restore dependencies
        run: dotnet restore

      - name: Clean and Publish app
        run: |
          dotnet clean
          dotnet publish -c Release -o ./publish

      - name: Deploy to deploy branch (incremental)
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path ..\deploy-temp | Out-Null
          Copy-Item -Recurse -Force .\publish\* ..\deploy-temp\

          cd ..
          if (Test-Path .\deploy) { Remove-Item -Recurse -Force .\deploy }
          git clone --depth=1 --branch=deploy https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git deploy
          cd deploy

          Copy-Item -Recurse -Force ..\deploy-temp\* .

          git config user.name "rianabd01"
          git config user.email "rianwahyuabd@gmail.com"

          git add -A
          git diff --quiet HEAD -- || (
            $timestamp = (Get-Date).ToString("yyyy-MM-dd HH:mm:ss")
            $message = "Update deploy $timestamp"
            git commit -m "$message"
            git push origin deploy
            Write-Host "✅ Changes detected and deployed."
            exit 0
          )

          Write-Host "ℹ️ No changes to deploy."
          exit 0
